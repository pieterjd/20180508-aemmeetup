<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>AEM Admin</title>
    <meta name="description" content="A framework for easily creating beautiful presentations using HTML">
    <meta name="author" content="Hakim El Hattab">

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/black.css">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <link rel="stylesheet" href="css/fontawesome/fa-svg-with-js.css">
    <!-- Printing and PDF exports -->
    <script>
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = window.location.search.match(/print-pdf/gi) ? 'css/print/pdf.css' : 'css/print/paper.css';
        document.getElementsByTagName('head')[0].appendChild(link);
    </script>
</head>
<body>
<div class="reveal">
    <div class="slides">
        <section>
            <h1>No more monkeywork</h1>
            <h3>with AEMAdmin</h3>
            <p>
                <small>Pieter-Jan Drouillon</small>
                <br/>
                <small>AEM Developer Meetup NL - May 8, 2018</small>
            </p>

        </section>
        <section data-background="#4d7e65">
            <h1>About me</h1>
            <ul style="list-style-type: none">
                <li><i class="fas fa-graduation-cap"></i> Academic background</li>
                <li><i class="fas fa-link"></i> Short-lived career in Supply Chain</li>
                <li><i class="fab fa-java"></i> Full-stack developer @ Design Is Dead</li>
            </ul>
        </section>
        <section>
            <section data-background="#4d7e65">
                <h1>Why?</h1>
            </section>
            <section>
                <h1>Point & Click</h1>
                <ol>
                    <li>Update property</li>
                    <li>Add node</li>
                    <li>Install content package</li>
                </ol>
            </section>
            <section>
                <h1>Stumbled on ...</h1>
                <img src="./images/curlCheatSheet01.png" width="30%"/>
                <img src="./images/curlCheatSheet02.png" width="40%"/>
                <img src="./images/curlCheatSheet03.png" width="40%"/>
            </section>
        </section>
        <section>
            <section data-background="#4d7e65">
                <h1>First attempt</h1>
            </section>
            <section>
                <pre>
                <code class="hljs" data-trim contenteditable>
function setProperty{
    param([int]$port=4502,[string]$server="http://localhost",[string]$path,[string] $property,[string]$value)

    $cmd = "curl.exe -u admin:admin -X POST --data $($property)=$($value) $($server):$($port)$($path)"
    return Invoke-Expression $cmd
}

function deletePage{
    param([int]$port=4502,[string]$path,[string]$name)
    Write-Host "deleting " $path+'/'+$name
    $cmd = 'curl.exe -X DELETE -u admin:admin -F"jcr:primaryType=cq:Page" http://localhost:'+$port+$path+'/'+$name
    Invoke-Expression $cmd
}
                </code>
                </pre>
            </section>
            <section>
                <h1>Downside</h1>
                I'm actually looking for something
                <ul>
                    <li>Testable</li>
                    <li>Lightweight</li>
                    <li>Easy & consistent syntax</li>
                </ul>
            </section>
        </section>
        <section>
            <section data-background="#4d7e65">
                <h1>Why not Java?</h1>
            </section>
            <section>
                <h1>Testable</h1>
                Junit & Mockito
            </section>
            <section>
                <h1>Lightweight</h1>
                Apache HttpClient, Commons Lang & com.github.tsohr:json
            </section>
            <section>
                <h1>Easy & consistent</h1>
                Naming convention & method chaining
            </section>
        </section>
        <section data-background="#4d7e65">
            <h1>Examples</h1>
        </section>
        <section>
            <section>
            <h2>Adding properties</h2>
            </section>
            <section>
                <pre>
                <code class="hljs" data-trim contenteditable>
CompositeCommand cc = new CompositeCommand();
//base website
String[] base_languages = {"nl","fr","en"};
String[] base_segments = {"retail","soho","sme"};
for(String lang:base_languages){
    for(String segment:base_segments){
        String path = String.format("/content/kpngb-base/%s/%s/sales-checkout/jcr:content",lang,segment);
        SetPropertyCommand spc = new SetPropertyCommand(path,"enableOnlineSales","True","Boolean");
        cc.add(spc);

        path = String.format("/content/kpngb-base/%s/%s/sales-registration/jcr:content",lang,segment);
        spc = new SetPropertyCommand(path,"enableOnlineSales","True","Boolean");
        cc.add(spc);
    }
}
cc.execute();
                </code>
                </pre>
            </section>
        </section>
        <section>
            <section>
                <h2>Query Command</h2>
                <img src="images/querydebugger.png"/>
            </section>
            <section>
                <pre>
                <code class="hljs" data-trim contenteditable>
public QueryCommand addCondition(String key,String value)
public QueryCommand setHitLimit(int limit)
public QueryCommand fullHit()
public int getResults()
public int getTotal()
public boolean hasMore()
                </code>
            </pre>
            </section>
        </section>
        <section>
            <section>
            <h2>PostProcess</h2>
            </section>
            <section>

                <pre style="height: 547px; width: 960px;">
                <code class="hljs" data-trim contenteditable>
/**
* Queries return JSON with an array called hits. This method will process one element of this array
* @param hit the result to process
*/
public abstract void postProcessOneResult(JSONObject hit);
                </code>
                </pre>
            </section>
            <section>
                <h2>Define query</h2>
                <pre>
                <code class="hljs" data-trim contenteditable>
public WorkflowInstancesQueryCommand(String status){
    addCondition("path","/etc/workflow/instances/server0");
    addCondition("p.hits","full");
    addCondition("orderby","endTime");
    if(status != null){
        addCondition("1_property","status");
        addCondition("1_value",status);
    }
    else{
        propertyExists("1_","status");
    }
    public String getOldestEndTime(){
        String result = null;
        JSONArray hits = getQueryResult().getJSONArray("hits");
        if(hits.length()>0){
            JSONObject hit = hits.getJSONObject(0);
            if(hit.has("endTime")){
                result = hit.getString("endTime");
                result += " path: "+hit.getString("jcr:path");
            }
        }
        return result;
    }
}
                </code>
                 </pre>
            </section>
            <section>
                <h2>Loop over hits</h2>
                <pre>
                <code class="hljs" data-trim contenteditable>
public class DifferentStatusValuesCommand extends QueryPostProcessCommand<WorkflowInstancesQueryCommand> {
    private Set<String> statuses;
    public DifferentStatusValuesCommand(WorkflowInstancesQueryCommand command) {
    super(command);
    statuses = new HashSet<>();
    }
    @Override
    public void postProcessOneResult(JSONObject hit) {
    statuses.add(hit.getString("status"));
    }

    public Set<String> getStatuses() {
        return statuses;
    }
}
                        </code>
                </pre>
            </section>
        </section>
        <section>
            <section>
                <h1>Instance install</h1>
                image eDev confluence
            </section>
            <section>
                <pre>
                <code class="hljs" data-trim contenteditable>
CompositeCommand cc = new CompositeCommand();
//Enable crx/de
EnableCrxCommand ecc = new EnableCrxCommand();
cc.add(ecc);
BulkPackageInstallCommand bpic = new BulkPackageInstallCommand();
//One off packages for a fresh install
bpic.addPackage("D:\\packages_to_install\\acs-aem-commons-content-3.13.0-min.zip")
.addPackage("D:\\packages_to_install\\acs-aem-tools-content-0.0.50-min.zip")
.addPackage("D:\\packages_to_install\\AEM-6.3-Service-Pack-1-6.3.1.zip")
.addPackage("D:\\packages_to_install\\cq-6.3.0-hotfix-19148-1.0.zip")
.addPackage("D:\\packages_to_install\\Content_auth_PROD_CRQ000000639702.zip")
.addPackage("D:\\packages_to_install\\Content_auth_PROD_CRQ000000639702_2.zip")
.addPackage("D:\\packages_to_install\\permissions.zip")
.addPackage("D:\\packages_to_install\\nprd_userGroups.zip");
//install the Java code
String version ="18.16.0-SNAPSHOT";
bpic.addPackage("C:\\_dev\\git\\telenet\\tcp.upc-generic\\app\\target/upc-generic.jar")
.addPackage(String.format("C:\\_dev\\git\\telenet\\tcp.upc-generic\\core\\target/upc-generic-core-%s.jar",version));
cc.add(bpic);
DeletePropertyCommand dpc = new DeletePropertyCommand("/content/www-telenet-be/jcr:content","cq:cloudserviceconfigs");
cc.add(dpc);
cc.execute();
System.out.println("Restart instance so all bundles are installed. You might have to start bundles manually.");
                </code>
                </pre>
            </section>
        </section>
        <section>
            <section data-background="#4d7e65">
                <h1>Other features</h1>
            </section>
            <section>
                <ul>
                    <li>Instance config via cmdline property</li>
                    <li>fat jar</li>
                </ul>
            </section>
        </section>
        <section>
            <section data-background="#4d7e65">
            <h1>Conclusion</h1>
            </section>
            <section>
            <ul>
                <li>Reduce point & click monkeywork</li>
                <li>Testable</li>
                <li>Lightweight</li>
                <li>Easy</li>
            </ul>
            <p>Available on <a href="http://github.com/pieterjd/aemadmin"><i class="fab fa-github"></i></a></p>
            </section>
        </section>
        <section>Who is this guy?
            <p>

            </p>
        </section>
        <section>
            <pre>
                <code class="hljs" data-trim contenteditable>
CompositeCommand cc = new CompositeCommand();
//Enable crx/de
EnableCrxCommand ecc = new EnableCrxCommand();
cc.add(ecc);
BulkPackageInstallCommand bpic = new BulkPackageInstallCommand();
bpic.addPackage("D:\\packages_to_install\\acs-aem-commons-content-3.13.0-min.zip")
.addPackage("D:\\packages_to_install\\acs-aem-tools-content-0.0.50-min.zip")
.addPackage("D:\\packages_to_install\\AEM-6.3-Service-Pack-1-6.3.1.zip")
.addPackage("D:\\packages_to_install\\cq-6.3.0-hotfix-19148-1.0.zip")
.addPackage("D:\\packages_to_install\\Content_auth_PROD_CRQ000000639702.zip")
.addPackage("D:\\packages_to_install\\Content_auth_PROD_CRQ000000639702_2.zip")
.addPackage("D:\\packages_to_install\\permissions.zip")
.addPackage("D:\\packages_to_install\\nprd_userGroups.zip");
//cloud service bug in the current content package - remove property
DeletePropertyCommand dpc = new DeletePropertyCommand("/content/www-telenet-be/jcr:content","cq:cloudserviceconfigs");
cc.add(dpc);
//dpc.execute();
cc.execute();
System.out.println("Restart author so all bundles are installed. You might have to start bundles manually.");
					</code>
            </pre>
        </section>
    </div>
</div>

<script src="lib/js/head.min.js"></script>
<script src="js/reveal.js"></script>
<script src="js/fontawesome/fontawesome-all.js"></script>
<script src="js/fontawesome/fa-solid.js"></script>

<script>
    // More info about config & dependencies:
    // - https://github.com/hakimel/reveal.js#configuration
    // - https://github.com/hakimel/reveal.js#dependencies
    Reveal.initialize({
        dependencies: [
            {src: 'plugin/markdown/marked.js'},
            {src: 'plugin/markdown/markdown.js'},
            {src: 'plugin/notes/notes.js', async: true},
            {
                src: 'plugin/highlight/highlight.js', async: true, callback: function () {
                hljs.initHighlightingOnLoad();
            }
            }
        ]
    });
</script>
</body>
</html>
